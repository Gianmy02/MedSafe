<div class="edit-container">
  <header class="page-header">
    <h1>I miei referti</h1>
    <p>Visualizza, modifica ed elimina i tuoi referti</p>
  </header>

  <!-- Messages -->
  <div *ngIf="errorMessage" class="alert alert-error">
    {{ errorMessage }}
  </div>
  <div *ngIf="successMessage" class="alert alert-success">
    {{ successMessage }}
  </div>
  <div *ngIf="isLoading" class="loading-spinner">
    <div class="spinner"></div>
    <p>Caricamento in corso...</p>
  </div>

  <!-- Results List -->
  <div *ngIf="referti.length > 0" class="results-section">
    <h2>Risultati: {{ referti.length }}</h2>
    <div class="referti-grid">
      <div *ngFor="let referto of referti" class="referto-card" [class.selected]="selectedReferto?.id === referto.id"
        (click)="selectReferto(referto)">
        <div class="referto-header">
          <h3>{{ referto.nomeFile }}</h3>
          <span class="badge" [ngClass]="getBadgeClass(referto.tipoEsame)">{{ formatTipoEsame(referto.tipoEsame)
            }}</span>
        </div>
        <div class="referto-body">
          <p><strong>CF Paziente:</strong> {{ referto.codiceFiscale }}</p>
          <p><strong>Data Caricamento:</strong> {{ referto.dataCaricamento | date:'dd/MM/yyyy HH:mm' }}</p>
          <p><strong>Medico:</strong> {{ referto.autoreEmail }}</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Selected Referto Details -->
  <div *ngIf="selectedReferto && !isEditMode" class="details-section card">
    <h2>Dettagli Referto</h2>

    <div class="details-grid">
      <div class="detail-item">
        <label>Nome File:</label>
        <span>{{ selectedReferto.nomeFile }}</span>
      </div>
      <div class="detail-item">
        <label>Tipo Esame:</label>
        <span>{{ formatTipoEsame(selectedReferto.tipoEsame) }}</span>
      </div>
      <div class="detail-item">
        <label>Codice Fiscale Paziente:</label>
        <span>{{ selectedReferto.codiceFiscale }}</span>
      </div>
      <div class="detail-item">
        <label>Data Caricamento:</label>
        <span>{{ selectedReferto.dataCaricamento | date:'dd/MM/yyyy HH:mm' }}</span>
      </div>
      <div class="detail-item">
        <label>Email Medico:</label>
        <span>{{ selectedReferto.autoreEmail }}</span>
      </div>
    </div>

    <div class="button-group">
      <button (click)="downloadPdf(selectedReferto.id!)" class="btn btn-primary">
        <span class="btn-icon">üìù</span>
        <span class="btn-text">Scarica Documento Referto</span>
      </button>
      <button (click)="downloadImmagine(selectedReferto.id!)" class="btn btn-info">
        <span class="btn-icon">üñºÔ∏è</span>
        <span class="btn-text">Scarica Esame</span>
      </button>
      <ng-container *ngIf="currentUser?.enabled">
        <button (click)="enterEditMode()" class="btn btn-accent">
          <span class="btn-icon">‚úèÔ∏è</span>
          <span class="btn-text">Modifica</span>
        </button>
        <button (click)="deleteReferto()" class="btn btn-danger">
          üóëÔ∏è Elimina
        </button>
      </ng-container>
    </div>
  </div>

  <!-- Edit Form -->
  <div *ngIf="isEditMode" class="edit-section card">
    <h2>Modifica Referto</h2>

    <form class="edit-form">
      <div class="form-group">
        <label for="editNomeFile">Nome File:</label>
        <input type="text" id="editNomeFile" [(ngModel)]="editData.nomeFile" name="nomeFile" class="form-control"
          required>
      </div>

      <div class="form-group">
        <label for="editTipoEsame">Tipo Esame:</label>
        <select id="editTipoEsame" [(ngModel)]="editData.tipoEsame" name="tipoEsame" class="form-control" required>
          <option value="TAC">TAC</option>
          <option value="Radiografia">Radiografia</option>
          <option value="Ecografia">Ecografia</option>
          <option value="Risonanza">Risonanza Magnetica</option>
          <option value="Esami_Laboratorio">Esami di Laboratorio</option>
        </select>
      </div>

      <div class="form-group">
        <label for="editCodiceFiscale">Codice Fiscale Paziente:</label>
        <input type="text" id="editCodiceFiscale" [(ngModel)]="editData.codiceFiscalePaziente" name="codiceFiscale"
          class="form-control" maxlength="16" required>
      </div>

      <div class="form-group full-width">
        <label for="editTestoReferto">Testo Referto: <span class="required">*</span></label>
        <textarea id="editTestoReferto" [(ngModel)]="editData.testoReferto" name="testoReferto" class="form-control"
          rows="6" placeholder="Inserisci il testo del referto..." required></textarea>
      </div>

      <div class="form-group full-width">
        <label for="editConclusioni">Conclusioni: <span class="required">*</span></label>
        <textarea id="editConclusioni" [(ngModel)]="editData.conclusioni" name="conclusioni" class="form-control"
          rows="4" placeholder="Inserisci le conclusioni..." required></textarea>
      </div>

      <div class="form-group full-width">
        <label for="editImmagine">Immagine Corrente:</label>
        <div class="current-file-info" *ngIf="selectedReferto?.fileUrlImmagine">
          <span class="file-icon">üñºÔ∏è</span>
          <span class="file-name">{{ getImageFileName(selectedReferto?.fileUrlImmagine) }}</span>
          <span class="file-status">‚úì Gi√† caricato</span>
        </div>
        <label for="editImmagine" class="mt-2">Cambia Immagine (opzionale):</label>
        <input type="file" id="editImmagine" (change)="onFileSelected($event)" accept="image/*"
          class="form-control file-input">
        <small class="form-help">Lascia vuoto per mantenere l'immagine corrente, oppure seleziona una nuova immagine per
          sostituirla</small>
      </div>

      <div class="button-group">
        <button type="button" (click)="saveEdit()" [disabled]="isLoading" class="btn btn-primary">
          üíæ Salva Modifiche
        </button>
        <button type="button" (click)="cancelEdit()" class="btn btn-secondary">
          ‚úñ Annulla
        </button>
      </div>
    </form>
  </div>
</div>