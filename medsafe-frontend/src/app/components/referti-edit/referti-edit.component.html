<div class="edit-container">
  <header class="page-header">
    <div class="header-icon">ğŸ“‹</div>
    <h1>I miei referti</h1>
    <p>Visualizza, modifica ed elimina i tuoi referti</p>
    <div class="header-stats" *ngIf="referti.length > 0">
      <span class="stat-badge">
        <span class="stat-number">{{ referti.length }}</span>
        <span class="stat-label">Referti Caricati</span>
      </span>
    </div>
    <div class="header-deco">
      <span>ğŸ©º</span><span>ğŸ“Š</span><span>ğŸ”¬</span><span>ğŸ’Š</span><span>ğŸ¥</span>
    </div>
  </header>

  <!-- Messages -->
  <div *ngIf="errorMessage" class="alert alert-error">
    {{ errorMessage }}
  </div>
  <div *ngIf="successMessage" class="alert alert-success">
    {{ successMessage }}
  </div>
  <div *ngIf="isLoading" class="loading-spinner">
    <div class="spinner"></div>
    <p>Caricamento in corso...</p>
  </div>

  <!-- Results List -->
  <div *ngIf="referti.length > 0" class="results-section">
    <h2>Risultati: {{ referti.length }}</h2>
    <div class="referti-grid">
      <div *ngFor="let referto of referti" class="referto-card" [class.selected]="selectedReferto?.id === referto.id"
        (click)="selectReferto(referto)">
        <div class="referto-header">
          <h3>{{ referto.nomeFile }}</h3>
          <span class="badge" [ngClass]="getBadgeClass(referto.tipoEsame)">{{ formatTipoEsame(referto.tipoEsame)
            }}</span>
        </div>
        <div class="referto-body">
          <p><strong>CF Paziente:</strong> {{ referto.codiceFiscale }}</p>
          <p><strong>Data Caricamento:</strong> {{ referto.dataCaricamento | date:'dd/MM/yyyy HH:mm' }}</p>
          <p><strong>Medico:</strong> {{ referto.autoreEmail }}</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Selected Referto Details -->
  <div *ngIf="selectedReferto && !isEditMode" class="details-section card">
    <div class="section-header">
      <span class="section-icon">ğŸ“„</span>
      <h2>Dettagli Referto</h2>
    </div>

    <div class="details-grid">
      <div class="detail-item">
        <div class="detail-icon">ğŸ“</div>
        <div class="detail-content">
          <label>Nome File</label>
          <span>{{ selectedReferto.nomeFile }}</span>
        </div>
      </div>
      <div class="detail-item">
        <div class="detail-icon">ğŸ”¬</div>
        <div class="detail-content">
          <label>Tipo Esame</label>
          <span class="badge-inline" [ngClass]="getBadgeClass(selectedReferto.tipoEsame)">{{
            formatTipoEsame(selectedReferto.tipoEsame) }}</span>
        </div>
      </div>
      <div class="detail-item">
        <div class="detail-icon">ğŸ†”</div>
        <div class="detail-content">
          <label>Codice Fiscale Paziente</label>
          <span class="mono-text">{{ selectedReferto.codiceFiscale }}</span>
        </div>
      </div>
      <div class="detail-item">
        <div class="detail-icon">ğŸ‘¤</div>
        <div class="detail-content">
          <label>Nome Paziente</label>
          <span>{{ selectedReferto.nomePaziente }}</span>
        </div>
      </div>
      <div class="detail-item">
        <div class="detail-icon">ğŸ“…</div>
        <div class="detail-content">
          <label>Data Caricamento</label>
          <span>{{ selectedReferto.dataCaricamento | date:'dd/MM/yyyy HH:mm' }}</span>
        </div>
      </div>
      <div class="detail-item">
        <div class="detail-icon">ğŸ©º</div>
        <div class="detail-content">
          <label>Email Medico</label>
          <span>{{ selectedReferto.autoreEmail }}</span>
        </div>
      </div>
    </div>

    <!-- Testo e conclusioni in evidenza -->
    <div class="detail-text-section" *ngIf="selectedReferto.testoReferto">
      <div class="text-block">
        <h4><span class="text-icon">ğŸ“</span> Descrizione Referto</h4>
        <p>{{ selectedReferto.testoReferto }}</p>
      </div>
    </div>
    <div class="detail-text-section" *ngIf="selectedReferto.conclusioni">
      <div class="text-block conclusioni-block">
        <h4><span class="text-icon">âœ…</span> Conclusioni</h4>
        <p>{{ selectedReferto.conclusioni }}</p>
      </div>
    </div>

    <div class="button-group details-actions">
      <button (click)="downloadPdf(selectedReferto.id!)" class="btn btn-primary btn-with-glow">
        <span class="btn-icon">ğŸ“</span>
        <span class="btn-text">Scarica Documento Referto</span>
      </button>
      <button (click)="downloadImmagine(selectedReferto.id!)" class="btn btn-info btn-with-glow">
        <span class="btn-icon">ğŸ–¼ï¸</span>
        <span class="btn-text">Scarica Esame</span>
      </button>
      <ng-container *ngIf="currentUser?.enabled">
        <button (click)="enterEditMode()" class="btn btn-accent btn-with-glow">
          <span class="btn-icon">âœï¸</span>
          <span class="btn-text">Modifica</span>
        </button>
        <button (click)="deleteReferto()" class="btn btn-danger btn-with-glow">
          <span class="btn-icon">ğŸ—‘ï¸</span>
          <span class="btn-text">Elimina</span>
        </button>
      </ng-container>
    </div>
  </div>

  <!-- Edit Form -->
  <div *ngIf="isEditMode" class="edit-section card">
    <div class="section-header">
      <span class="section-icon">âœï¸</span>
      <h2>Modifica Referto</h2>
    </div>

    <form class="edit-form">
      <div class="form-group">
        <label for="editNomeFile"><span class="label-icon">ğŸ“</span> Nome File <span class="required">*</span></label>
        <input type="text" id="editNomeFile" [(ngModel)]="editData.nomeFile" name="nomeFile" class="form-control"
          required placeholder="referto_001">
      </div>

      <div class="form-group">
        <label for="editTipoEsame"><span class="label-icon">ğŸ”¬</span> Tipo Esame <span class="required">*</span></label>
        <select id="editTipoEsame" [(ngModel)]="editData.tipoEsame" name="tipoEsame" class="form-control" required>
          <option value="TAC">TAC</option>
          <option value="Radiografia">Radiografia</option>
          <option value="Ecografia">Ecografia</option>
          <option value="Risonanza">Risonanza Magnetica</option>
          <option value="Esami_Laboratorio">Esami di Laboratorio</option>
        </select>
      </div>

      <div class="form-group">
        <label for="editCodiceFiscale"><span class="label-icon">ğŸ†”</span> Codice Fiscale Paziente <span
            class="required">*</span></label>
        <input type="text" id="editCodiceFiscale" [(ngModel)]="editData.codiceFiscalePaziente" name="codiceFiscale"
          class="form-control" maxlength="16" required placeholder="RSSMRA80A01H501U"
          (input)="editData.codiceFiscalePaziente = editData.codiceFiscalePaziente.toUpperCase()">
      </div>

      <div class="form-group full-width">
        <label for="editTestoReferto"><span class="label-icon">ğŸ“</span> Descrizione Referto <span
            class="required">*</span> <small>(max 320 caratteri)</small></label>
        <textarea id="editTestoReferto" [(ngModel)]="editData.testoReferto" name="testoReferto" class="form-control"
          rows="5" maxlength="320" placeholder="Inserisci il testo del referto..." required></textarea>
        <small class="char-counter">{{ editData.testoReferto?.length || 0 }}/320</small>
      </div>

      <div class="form-group full-width">
        <label for="editConclusioni"><span class="label-icon">âœ…</span> Conclusioni <span class="required">*</span>
          <small>(max 500 caratteri)</small></label>
        <textarea id="editConclusioni" [(ngModel)]="editData.conclusioni" name="conclusioni" class="form-control"
          rows="4" maxlength="500" placeholder="Inserisci le conclusioni..." required></textarea>
        <small class="char-counter">{{ editData.conclusioni?.length || 0 }}/500</small>
      </div>

      <div class="form-group full-width">
        <label for="editImmagine"><span class="label-icon">ğŸ–¼ï¸</span> Immagine Corrente</label>

        <!-- Existing image preview -->
        <div class="image-preview-section" *ngIf="existingImageUrl && !newFilePreviewUrl">
          <div class="preview-wrapper">
            <img [src]="existingImageUrl" alt="Immagine corrente" class="preview-img">
          </div>
          <div class="current-file-info">
            <span class="file-icon">ğŸ–¼ï¸</span>
            <span class="file-name">{{ getImageFileName(selectedReferto?.fileUrlImmagine) }}</span>
            <span class="file-status">âœ“ Immagine attuale</span>
          </div>
        </div>

        <!-- No image available -->
        <div class="no-image-info" *ngIf="!existingImageUrl && !newFilePreviewUrl && !selectedFile">
          <span class="file-icon">ğŸ“·</span>
          <span>Nessuna immagine caricata</span>
        </div>

        <!-- New file preview -->
        <div class="image-preview-section new-preview" *ngIf="newFilePreviewUrl">
          <div class="preview-wrapper">
            <img [src]="newFilePreviewUrl" alt="Nuova immagine" class="preview-img">
          </div>
          <div class="current-file-info">
            <span class="file-icon">ğŸ†•</span>
            <span class="file-name">{{ selectedFile?.name }}</span>
            <span class="file-status new-status">âŸ³ SostituirÃ  l'immagine attuale</span>
          </div>
        </div>

        <!-- New file is PDF (no preview) -->
        <div class="no-image-info" *ngIf="selectedFile && !newFilePreviewUrl">
          <span class="file-icon">ğŸ“„</span>
          <span class="file-name">{{ selectedFile.name }}</span>
          <span class="pdf-hint">Anteprima non disponibile per i PDF</span>
        </div>

        <label for="editImmagine" class="mt-2"><span class="label-icon">ğŸ“</span> Cambia Immagine (opzionale):</label>
        <input type="file" id="editImmagine" (change)="onFileSelected($event)" accept="image/*"
          class="form-control file-input">
        <small class="form-help">Lascia vuoto per mantenere l'immagine corrente, oppure seleziona una nuova immagine per
          sostituirla</small>
      </div>

      <div class="button-group">
        <button type="button" (click)="saveEdit()" [disabled]="isLoading" class="btn btn-primary btn-with-glow">
          <span class="btn-icon">ğŸ’¾</span>
          <span class="btn-text">Salva Modifiche</span>
        </button>
        <button type="button" (click)="cancelEdit()" class="btn btn-secondary">
          <span class="btn-icon">âœ–</span>
          <span class="btn-text">Annulla</span>
        </button>
      </div>
    </form>
  </div>
</div>